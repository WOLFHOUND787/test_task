<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõçÔ∏è –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hide { display: none; }
        .card { margin-bottom: 20px; }
        .shop-card { transition: transform 0.2s; cursor: pointer; }
        .shop-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-2px); }
        .navbar-brand { font-weight: bold; }
        .user-info { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .shop-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin: -15px -15px 15px -15px;
        }
        .order-item {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .order-item.pending {
            border-left-color: #ffc107;
        }
        .order-item.completed {
            border-left-color: #28a745;
        }
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">üõçÔ∏è –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</a>
            <div class="navbar-nav ms-auto" id="authButtons">
                <button class="btn btn-outline-light me-2" onclick="showProfile()" id="profileBtn" style="display: none;">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                <button class="btn btn-outline-danger" onclick="logout()" id="logoutBtn" style="display: none;">üö™ –í—ã—Ö–æ–¥</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div id="loginSection" class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="authTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">–í—Ö–æ–¥</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="authTabContent">
                            <!-- –í—Ö–æ–¥ -->
                            <div class="tab-pane fade show active" id="login" role="tabpanel">
                                <form id="loginForm">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                                        <input type="password" class="form-control" id="password" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">–í–æ–π—Ç–∏</button>
                                </form>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        –¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:<br>
                                        ‚Ä¢ admin@example.com / admin123 (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)<br>
                                        ‚Ä¢ manager@example.com / manager123 (–º–µ–Ω–µ–¥–∂–µ—Ä)<br>
                                        ‚Ä¢ user@example.com / user123 (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
                                    </small>
                                </div>
                            </div>
                            <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
                            <div class="tab-pane fade" id="register" role="tabpanel">
                                <form id="registerForm">
                                    <div class="mb-3">
                                        <label for="regEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="regEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="regFullName" class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                                        <input type="text" class="form-control" id="regFullName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="regPassword" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                                        <input type="password" class="form-control" id="regPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="regPasswordConfirm" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
                                        <input type="password" class="form-control" id="regPasswordConfirm" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="regRole" class="form-label">–†–æ–ª—å</label>
                                        <select class="form-select" id="regRole">
                                            <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                            <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-success w-100">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div id="mainSection" class="hide">
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º -->
            <div class="btn-group mb-4" role="group">
                <button type="button" class="btn btn-outline-primary" id="shopsBtn" onclick="showShops()">üè™ –ú–∞–≥–∞–∑–∏–Ω—ã</button>
                <button type="button" class="btn btn-outline-primary" id="ordersBtn" onclick="showOrders()">üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>
                <button type="button" class="btn btn-outline-primary" id="manageShopBtn" onclick="showManageShop()" style="display: none;">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º</button>
                <button type="button" class="btn btn-outline-primary" id="usersBtn" onclick="showUsers()" style="display: none;">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            </div>

            <!-- –ú–∞–≥–∞–∑–∏–Ω—ã -->
            <div id="shopsSection" class="hide">
                <h3>üè™ –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã</h3>
                <div id="shopsList" class="row"></div>
            </div>

            <!-- –ü—Ä–æ–¥—É–∫—Ç—ã –º–∞–≥–∞–∑–∏–Ω–∞ -->
            <div id="productsSection" class="hide">
                <div class="shop-header">
                    <h4 id="shopName"></h4>
                    <p id="shopInfo"></p>
                    <button class="btn btn-light btn-sm" onclick="showShops()">‚Üê –ù–∞–∑–∞–¥ –∫ –º–∞–≥–∞–∑–∏–Ω–∞–º</button>
                </div>
                <div id="productsList" class="row mt-3"></div>
            </div>

            <!-- –ó–∞–∫–∞–∑—ã -->
            <div id="ordersSection" class="hide">
                <h3>üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
                <div id="ordersList"></div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤) -->
            <div id="manageShopSection" class="hide">
                <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–ú–æ–π –º–∞–≥–∞–∑–∏–Ω</h5>
                                <button class="btn btn-success btn-sm" onclick="showCreateShopForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
                            </div>
                            <div class="card-body" id="myShopInfo">
                                <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞–≥–∞–∑–∏–Ω–µ...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h5>
                            </div>
                            <div class="card-body">
                                <form id="addProductForm">
                                    <div class="mb-3">
                                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                        <input type="text" class="form-control" id="productName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                        <textarea class="form-control" id="productDescription"></textarea>
                                    </div>
                                    <div class="mb-3" id="shopSelectContainer" style="display: none;">
                                        <label class="form-label">–ú–∞–≥–∞–∑–∏–Ω</label>
                                        <select class="form-control" id="productShop">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">–¶–µ–Ω–∞</label>
                                        <input type="number" class="form-control" id="productPrice" step="0.01" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <h5>üì¶ –ó–∞–∫–∞–∑—ã –Ω–∞ –º–æ–∏ —Ç–æ–≤–∞—Ä—ã</h5>
                    <div id="shopOrders"></div>
                </div>
            </div>

            <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) -->
            <div id="usersSection" class="hide">
                <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                <div id="usersList"></div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataModalLabel">–î–∞–Ω–Ω—ã–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                    <div id="dataModalContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let currentShopId = null;
        let accessToken = localStorage.getItem('accessToken');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            if (accessToken) {
                checkToken();
            } else {
                showLogin();
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
        async function authenticatedFetch(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            const response = await fetch(url, { ...options, ...defaultOptions });
            
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ (401), –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
            if (response.status === 401) {
                try {
                    const refreshResponse = await fetch(`${API_BASE}/auth/refresh/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            refresh: localStorage.getItem('refreshToken')
                        })
                    });
                    
                    if (refreshResponse.ok) {
                        const data = await refreshResponse.json();
                        accessToken = data.access;
                        localStorage.setItem('accessToken', accessToken);
                        
                        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
                        defaultOptions.headers['Authorization'] = `Bearer ${accessToken}`;
                        return fetch(url, { ...options, ...defaultOptions });
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω, —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        accessToken = null;
                        currentUser = null;
                        showLogin();
                        throw new Error('Token expired');
                    }
                } catch (error) {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    accessToken = null;
                    currentUser = null;
                    showLogin();
                    throw new Error('Token refresh failed');
                }
            }
            
            return response;
        }

        async function checkToken() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/auth/profile/`);
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data;
                    showMain();
                } else {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    showLogin();
                }
            } catch (error) {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginSection').classList.remove('hide');
            document.getElementById('mainSection').classList.add('hide');
            document.getElementById('profileBtn').style.display = 'none';  // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            document.getElementById('logoutBtn').style.display = 'none';  // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã—Ö–æ–¥
        }

        function showMain() {
            document.getElementById('loginSection').classList.add('hide');
            document.getElementById('mainSection').classList.remove('hide');
            document.getElementById('profileBtn').style.display = 'block';  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            document.getElementById('logoutBtn').style.display = 'block';  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã—Ö–æ–¥
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            const isManager = currentUser.roles && currentUser.roles.some(role => role.name === 'manager');
            const isAdmin = currentUser.roles && currentUser.roles.some(role => role.name === 'admin');
            
            // –í—Å–µ –≤–∏–¥—è—Ç –º–∞–≥–∞–∑–∏–Ω—ã, –º–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥—è—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            document.getElementById('shopsBtn').style.display = 'block';
            document.getElementById('ordersBtn').style.display = isManager ? 'none' : 'block';
            document.getElementById('manageShopBtn').style.display = isManager ? 'block' : 'none';
            document.getElementById('usersBtn').style.display = isAdmin ? 'block' : 'none';
            
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            if (isManager) {
                showManageShop(); // –ú–µ–Ω–µ–¥–∂–µ—Ä—ã —Å—Ä–∞–∑—É –≤–∏–¥—è—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º
            } else {
                showShops(); // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –º–∞–≥–∞–∑–∏–Ω—ã
            }
        }

        // –í—Ö–æ–¥
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    localStorage.setItem('accessToken', accessToken);
                    if (data.refresh_token) {
                        localStorage.setItem('refreshToken', data.refresh_token);
                    }
                    currentUser = data.user;
                    showMain();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (error.detail || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const full_name = document.getElementById('regFullName').value;
            const password = document.getElementById('regPassword').value;
            const password_confirm = document.getElementById('regPasswordConfirm').value;
            const role = document.getElementById('regRole').value;
            
            if (password !== password_confirm) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, full_name, password, password_confirm, role })
                });
                
                if (response.ok) {
                    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
                    document.getElementById('register-tab').click();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + JSON.stringify(error));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω—ã
        async function showShops() {
            hideAllSections();
            document.getElementById('shopsSection').classList.remove('hide');
            
            try {
                const response = await fetch(`${API_BASE}/business/shops/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const shopsList = document.getElementById('shopsList');
                    shopsList.innerHTML = '';
                    
                    data.shops.forEach(shop => {
                        const shopCard = `
                            <div class="col-md-4 mb-3">
                                <div class="card shop-card" onclick="showShopProducts('${shop.id}')">
                                    <div class="card-body">
                                        <h5 class="card-title">${shop.name}</h5>
                                        <p class="card-text">
                                            üìç ${shop.address}<br>
                                            üìû ${shop.phone}
                                        </p>
                                        <button class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        shopsList.innerHTML += shopCard;
                    });
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –º–∞–≥–∞–∑–∏–Ω–∞
        async function showShopProducts(shopId) {
            currentShopId = shopId;
            hideAllSections();
            document.getElementById('productsSection').classList.remove('hide');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞–≥–∞–∑–∏–Ω–µ
                const shopsResponse = await fetch(`${API_BASE}/business/shops/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (shopsResponse.ok) {
                    const shopsData = await shopsResponse.json();
                    const shop = shopsData.shops.find(s => s.id === shopId);
                    if (shop) {
                        document.getElementById('shopName').textContent = shop.name;
                        document.getElementById('shopInfo').textContent = `${shop.address} ‚Ä¢ ${shop.phone}`;
                    }
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –º–∞–≥–∞–∑–∏–Ω–∞
                const productsResponse = await fetch(`${API_BASE}/business/shops/${shopId}/products/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (productsResponse.ok) {
                    const data = await productsResponse.json();
                    const productsList = document.getElementById('productsList');
                    productsList.innerHTML = '';
                    
                    data.products.forEach(product => {
                        // –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –º–æ–≥—É—Ç –∑–∞–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –≤–æ–æ–±—â–µ
                        const isManager = currentUser.roles && currentUser.roles.some(role => role.name === 'manager');
                        const orderButton = isManager ? '' : `<button class="btn btn-success" onclick="showOrderModal('${product.id}', '${product.name}', ${product.price})">üõí –ó–∞–∫–∞–∑–∞—Ç—å</button>`;
                        
                        const productCard = `
                            <div class="col-md-4 mb-3">
                                <div class="card product-card">
                                    <div class="card-body">
                                        <h5 class="card-title">${product.name}</h5>
                                        <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-success">‚ÇΩ${product.price}</span>
                                        ${orderButton}
                                    </div>
                                </div>
                            </div>
                        `;
                        productsList.innerHTML += productCard;
                    });
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤');
            }
        }

        // –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
        async function createOrder(productId, productName, price, quantity) {
            try {
                const response = await fetch(`${API_BASE}/business/orders/create/`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: quantity
                    })
                });
                
                if (response.ok) {
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    showOrders();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–∫–∞–∑–∞
        function showOrderModal(productId, productName, price) {
            const modalContent = `
                <form id="orderForm">
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–æ–¥—É–∫—Ç</label>
                        <input type="text" class="form-control" value="${productName}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
                        <input type="text" class="form-control" value="‚ÇΩ${price}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <input type="number" class="form-control" id="quantityInput" min="1" value="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                        <input type="text" class="form-control" id="totalPriceInput" value="‚ÇΩ${price}" readonly>
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
                </form>
            `;
            
            document.getElementById('dataModalLabel').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞';
            document.getElementById('dataModalContent').innerHTML = modalContent;
            
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            modal.show();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            document.getElementById('quantityInput').addEventListener('input', function() {
                const quantity = parseInt(this.value) || 0;
                const totalPrice = price * quantity;
                document.getElementById('totalPriceInput').value = `‚ÇΩ${totalPrice}`;
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('orderForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const quantity = parseInt(document.getElementById('quantityInput').value);
                modal.hide();
                createOrder(productId, productName, price, quantity);
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫–∞–∑—ã
        async function showOrders() {
            hideAllSections();
            document.getElementById('ordersSection').classList.remove('hide');
            
            try {
                const response = await fetch(`${API_BASE}/business/orders/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const ordersList = document.getElementById('ordersList');
                    ordersList.innerHTML = '';
                    
                    if (data.orders.length === 0) {
                        ordersList.innerHTML = '<p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>';
                        return;
                    }
                    
                    data.orders.forEach(order => {
                        let statusText = '';
                        let buttons = '';
                        
                        if (order.status === 'pending') {
                            statusText = '‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
                            buttons = `<button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>`;
                        } else if (order.status === 'completed') {
                            statusText = '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω';
                            buttons = '';
                        } else if (order.status === 'cancelled') {
                            statusText = '‚ùå –û—Ç–º–µ–Ω–µ–Ω';
                            buttons = `<button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                        }
                        
                        const orderItem = `
                            <div class="order-item ${order.status}">
                                <h6>${order.product_name}</h6>
                                <p class="mb-1">
                                    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${order.quantity}<br>
                                    –°—É–º–º–∞: ‚ÇΩ${order.total_price}<br>
                                    –°—Ç–∞—Ç—É—Å: ${statusText}<br>
                                    –î–∞—Ç–∞: ${new Date(order.created_at).toLocaleDateString()}
                                </p>
                                ${buttons}
                            </div>
                        `;
                        ordersList.innerHTML += orderItem;
                    });
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤)
        async function showManageShop() {
            hideAllSections();
            document.getElementById('manageShopSection').classList.remove('hide');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–≥–∞–∑–∏–Ω—ã
                const shopsResponse = await fetch(`${API_BASE}/business/shops/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (shopsResponse.ok) {
                    const shopsData = await shopsResponse.json();
                    const myShops = shopsData.shops.filter(shop => shop.owner_id === currentUser.id);
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
                    const shopSelect = document.getElementById('productShop');
                    const shopSelectContainer = document.getElementById('shopSelectContainer');
                    
                    if (shopSelect && shopSelectContainer) {
                        shopSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω...</option>';
                        
                        if (myShops.length > 1) {
                            // –ï—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                            shopSelectContainer.style.display = 'block';
                            myShops.forEach(shop => {
                                const option = document.createElement('option');
                                option.value = shop.id;
                                option.textContent = shop.name;
                                shopSelect.appendChild(option);
                            });
                        } else if (myShops.length === 1) {
                            // –ï—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω –æ–¥–∏–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                            shopSelectContainer.style.display = 'none';
                        } else {
                            // –ï—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–µ—Ç
                            shopSelectContainer.style.display = 'none';
                        }
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞–≥–∞–∑–∏–Ω–∞—Ö
                    const myShopInfo = document.getElementById('myShopInfo');
                    if (myShops.length > 0) {
                        let shopsHtml = '';
                        myShops.forEach(shop => {
                            shopsHtml += `
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6>${shop.name}</h6>
                                        <p class="mb-1">
                                            üìç ${shop.address}<br>
                                            üìû ${shop.phone}<br>
                                            üìÖ –°–æ–∑–¥–∞–Ω: ${new Date(shop.created_at).toLocaleDateString()}
                                        </p>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editShop('${shop.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                        <button class="btn btn-sm btn-danger ms-2" onclick="deleteShop('${shop.id}', '${shop.name}')">–£–¥–∞–ª–∏—Ç—å</button>
                                    </div>
                                </div>
                            `;
                        });
                        myShopInfo.innerHTML = shopsHtml;
                    } else {
                        myShopInfo.innerHTML = `
                            <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–∞</p>
                            <button class="btn btn-primary" onclick="showCreateShopForm()">–°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
                        `;
                    }
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã –Ω–∞ —Ç–æ–≤–∞—Ä—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                const ordersResponse = await fetch(`${API_BASE}/business/orders/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (ordersResponse.ok) {
                    const ordersData = await ordersResponse.json();
                    const shopOrdersDiv = document.getElementById('shopOrders');
                    
                    if (ordersData.orders.length === 0) {
                        shopOrdersDiv.innerHTML = '<p class="text-muted">–ó–∞–∫–∞–∑–æ–≤ –Ω–∞ –≤–∞—à–∏ —Ç–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    } else {
                        shopOrdersDiv.innerHTML = '';
                        ordersData.orders.forEach(order => {
                            let statusText = '';
                            let buttons = '';
                            
                            if (order.status === 'pending') {
                                statusText = '‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
                                buttons = `<button class="btn btn-sm btn-success" onclick="completeOrder('${order.id}')">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>`;
                            } else if (order.status === 'completed') {
                                statusText = '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω';
                                buttons = '';
                            } else if (order.status === 'cancelled') {
                                statusText = '‚ùå –û—Ç–º–µ–Ω–µ–Ω';
                                buttons = '';
                            }
                            
                            const orderItem = `
                                <div class="order-item ${order.status}">
                                    <h6>${order.product_name}</h6>
                                    <p class="mb-1">
                                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${order.quantity}<br>
                                        –°—É–º–º–∞: ‚ÇΩ${order.total_price}<br>
                                        –°—Ç–∞—Ç—É—Å: ${statusText}<br>
                                        –î–∞—Ç–∞: ${new Date(order.created_at).toLocaleDateString()}
                                    </p>
                                    ${buttons}
                                </div>
                            `;
                            shopOrdersDiv.innerHTML += orderItem;
                        });
                    }
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–∞');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
        function showCreateShopForm() {
            const modalContent = `
                <form id="createShopForm">
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞</label>
                        <input type="text" class="form-control" id="shopNameInput" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ê–¥—Ä–µ—Å</label>
                        <input type="text" class="form-control" id="shopAddressInput" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" class="form-control" id="shopPhoneInput" required>
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
                </form>
            `;
            
            document.getElementById('dataModalLabel').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞';
            document.getElementById('dataModalContent').innerHTML = modalContent;
            
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            modal.show();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
            document.getElementById('createShopForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createShop();
            });
        }

        // –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω
        async function createShop() {
            const nameElement = document.getElementById('shopNameInput');
            const addressElement = document.getElementById('shopAddressInput');
            const phoneElement = document.getElementById('shopPhoneInput');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            if (!nameElement || !addressElement || !phoneElement) {
                alert('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                return;
            }
            
            const name = nameElement.value.trim();
            const address = addressElement.value.trim();
            const phone = phoneElement.value.trim();
            
            console.log('Creating shop:', { name, address, phone }); // Debug
            
            if (!name || !address || !phone) {
                alert('–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/business/shops/create/`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        address: address,
                        phone: phone
                    })
                });
                
                if (response.ok) {
                    alert('–ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
                    showManageShop();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('Error creating shop:', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω
        async function editShop(shopId) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞
                const shopsResponse = await fetch(`${API_BASE}/business/shops/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (shopsResponse.ok) {
                    const shopsData = await shopsResponse.json();
                    const shop = shopsData.shops.find(s => s.id === shopId);
                    
                    if (shop) {
                        const modalContent = `
                            <form id="editShopForm">
                                <div class="mb-3">
                                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞</label>
                                    <input type="text" class="form-control" id="editShopName" value="${shop.name}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–ê–¥—Ä–µ—Å</label>
                                    <input type="text" class="form-control" id="editShopAddress" value="${shop.address}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                    <input type="text" class="form-control" id="editShopPhone" value="${shop.phone}" required>
                                </div>
                                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                            </form>
                        `;
                        
                        document.getElementById('dataModalLabel').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞';
                        document.getElementById('dataModalContent').innerHTML = modalContent;
                        
                        const modal = new bootstrap.Modal(document.getElementById('dataModal'));
                        modal.show();
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
                        document.getElementById('editShopForm').addEventListener('submit', async function(e) {
                            e.preventDefault();
                            await updateShop(shopId);
                        });
                    }
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–∞');
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω
        async function updateShop(shopId) {
            const name = document.getElementById('editShopName').value;
            const address = document.getElementById('editShopAddress').value;
            const phone = document.getElementById('editShopPhone').value;
            
            try {
                const response = await fetch(`${API_BASE}/business/shops/${shopId}/update/`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        address: address,
                        phone: phone
                    })
                });
                
                if (response.ok) {
                    alert('–ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
                    showManageShop();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
        document.getElementById('addProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('productName').value;
            const description = document.getElementById('productDescription').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const shopSelect = document.getElementById('productShop');
            const shopId = shopSelect ? shopSelect.value : null;
            
            try {
                const requestBody = {
                    name: name,
                    description: description,
                    price: price
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º shop_id —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
                if (shopId) {
                    requestBody.shop_id = shopId;
                }
                
                const response = await fetch(`${API_BASE}/business/products/create/`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    alert('–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    document.getElementById('addProductForm').reset();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –µ—Å–ª–∏ –º—ã –≤ —Å–µ–∫—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
                    if (currentShopId) {
                        showShopProducts(currentShopId);
                    }
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –∞–¥–º–∏–Ω–∞)
        async function showUsers() {
            hideAllSections();
            document.getElementById('usersSection').classList.remove('hide');
            
            try {
                const response = await fetch(`${API_BASE}/business/users/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const usersList = document.getElementById('usersList');
                    usersList.innerHTML = '';
                    
                    data.users.forEach(user => {
                        const userItem = `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6>${user.full_name || user.email}</h6>
                                    <p class="mb-1">
                                        üìß ${user.email}<br>
                                        üé≠ –†–æ–ª—å: ${user.roles.map(r => r.name).join(', ')}<br>
                                        üìÖ –°–æ–∑–¥–∞–Ω: ${new Date(user.created_at).toLocaleDateString()}
                                    </p>
                                </div>
                            </div>
                        `;
                        usersList.innerHTML += userItem;
                    });
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        async function showProfile() {
            try {
                const response = await fetch(`${API_BASE}/business/profile/`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const modalContent = `
                        <form id="profileForm">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="${data.email}" readonly>
                                <small class="text-muted">Email –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                                <input type="text" class="form-control" value="${data.full_name || ''}" id="profileFullName">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–†–æ–ª—å</label>
                                <input type="text" class="form-control" value="${data.roles && data.roles.length > 0 ? data.roles.map(r => r.name).join(', ') : '–ù–µ—Ç —Ä–æ–ª–∏'}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                                <input type="text" class="form-control" value="${data.created_at ? new Date(data.created_at).toLocaleDateString() : '–ù/–î'}" readonly>
                            </div>
                            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-danger ms-2" onclick="deleteAccount()">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                        </form>
                    `;
                    
                    document.getElementById('dataModalLabel').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è';
                    document.getElementById('dataModalContent').innerHTML = modalContent;
                    
                    const modal = new bootstrap.Modal(document.getElementById('dataModal'));
                    modal.show();
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                    document.getElementById('profileForm').addEventListener('submit', async function(e) {
                        e.preventDefault();
                        await updateProfile();
                    });
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è');
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        async function updateProfile() {
            try {
                const fullName = document.getElementById('profileFullName').value;
                
                const response = await fetch(`${API_BASE}/business/profile/`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        full_name: fullName
                    })
                });
                
                if (response.ok) {
                    alert('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
                    checkToken(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        async function deleteAccount() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/business/profile/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                    localStorage.removeItem('accessToken');
                    showLogin();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑
        async function completeOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/business/orders/${orderId}/complete/`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                    showManageShop(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
        async function cancelOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/business/orders/${orderId}/cancel/`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω!');
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    const isManager = currentUser.roles && currentUser.roles.some(role => role.name === 'manager');
                    if (isManager) {
                        showManageShop(); // –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–æ–º
                    } else {
                        showOrders(); // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –∫ —Å–≤–æ–∏–º –∑–∞–∫–∞–∑–∞–º
                    }
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑
        async function deleteOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/business/orders/${orderId}/delete/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    const isManager = currentUser.roles && currentUser.roles.some(role => role.name === 'manager');
                    if (isManager) {
                        showManageShop(); // –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–æ–º
                    } else {
                        showOrders(); // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –∫ —Å–≤–æ–∏–º –∑–∞–∫–∞–∑–∞–º
                    }
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –£–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω
        async function deleteShop(shopId, shopName) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω "${shopName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/business/shops/${shopId}/delete/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    alert('–ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                    showShops(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤
                    // –ï—Å–ª–∏ –º—ã –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–æ–º, —Ç–æ–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º
                    if (document.getElementById('manageShopSection').classList.contains('hide') === false) {
                        showManageShop();
                    }
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞: ' + (error.error || '–û—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            accessToken = null;
            currentUser = null;
            showLogin();
        }

        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        function hideAllSections() {
            document.getElementById('shopsSection').classList.add('hide');
            document.getElementById('productsSection').classList.add('hide');
            document.getElementById('ordersSection').classList.add('hide');
            document.getElementById('manageShopSection').classList.add('hide');
            document.getElementById('usersSection').classList.add('hide');
        }
    </script>
</body>
</html>
